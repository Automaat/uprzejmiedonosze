{% set leftButton = '' %}
{% set rightButton = '' %}

{% set title = 'Generator' %}
{% set shortTitle = 'Generator' %}
{% set description = 'Generator' %}
{% set mainClass = 'how' %}

{% extends "base.html.twig" %}
{% block footer %}
<footer></footer>
{% endblock %}
{% block main %}

<style>
fieldset>label {
 display: flex;
 align-items: center;
 border: 1px solid #eee;
 margin-bottom: 1em;
 padding: 0.5em;
}
fieldset>label>input {
 flex-shrink: 0;
 margin: 0 8px 0 0;
 align-self: center;
 display: flex !important;
 width: 1em;
}
    .form-group {
        margin-bottom: 15px;
    }
    .topics-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 10px;
        margin-bottom: 15px;
    }
    .topic-desc {
        font-size: 0.85em;
        color: #666;
        margin-top: 2px;
    }
    input[type="text"], 
    select, 
    textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
    }
    #output {
        margin-top: 20px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        min-height: 200px;
        background-color: white;
        white-space: pre-wrap;
        font-family: 'Courier New', Courier, monospace;
    }
    .status {
        margin-top: 10px;
        font-style: italic;
        color: #7f8c8d;
    }
    #generator>section {
        display: none;
    }
    #generator>section.active {
        display: block !important;
    }
</style>


<div id='generator'>
  <header>
    <p id="step-indicator">Krok 1 z 4</p>
  </header>

  <section id="step-0" class="step-section active">
    <h2>Uprzejmy generator pism</h2>
    {% if isPatron %}
    <h4>Narzędzie jest w fazie testowej</h4>
    <p>Nie wysyłaj jeszcze wygenerowanych pism. Będę zobowiązany za feedback na adres <a href="mailto:szymon@uprzejmiedonosze.net">szymon@uprzejmiedonosze.net</a>.
    Pamiętaj, że generowanie każdego wniosku kosztuje (od kilku do kilkudziesięciu groszy, w zależności od ustawień, które tuninguję).
    Staraj się nie przekroczyć 10 prób.</p>
    {% else %}
    <h4>Narzędzie jest w fazie testowej dostępnej tylko dla Patronów i Patronek</h4>
    <p>Po fazie zamkniętych testów zostanie udostępnione wszystkim użytkownikom Uprzejmie Donoszę.</p>
    {% endif %}
    <nav>
        <button class="button" type="button" data-action="next" {% if not isPatron %}disabled{% endif %}>Dalej</button>
    </nav>
  </section>

  <section id="step-1" class="step-section">
    <h2>Co Cię najbardziej wkurza w pato parkowaniu?</h2>
    <p>Wybierz do 3 opcji.</p>
    <div id="topicError" style="color: red; display: none;">Wybierz od 1 do 3 tematów</div>
    <fieldset id="fs-topics">
    </fieldset>
    <nav>
        <button class="button" type="button" data-action="next" {% if not isPatron %}disabled{% endif %}>Dalej</button>
    </nav>
  </section>

  <section id="step-2" class="step-section">
    <h2>Wybierz typ pisma</h2>
    <fieldset>

      <label for="formType">Typ pisma:
      <select id="formType" disabled>
          <option value="">Ładowanie typów pism...</option>
      </select></label>

      <label for="target">Adresat:
      <select id="target" disabled>
          <option value="">Najpierw wybierz typ pisma</option>
      </select></label>
    </fieldset>
    <nav>
        {% if isPatron %}
        <button id="generateButton" class="button cta">Generuj pismo</button>
        {% else %}
        <button id="generateButton" class="button disabled">Generuj pismo</button>
        {% endif %}
    </nav>
  </section>

  <section id="step-3" class="step-section">
    <h2>Wygenerowane pismo</h2>
    <div class="status" id="status">Gotowy do generowania</div>
    <div id="output"></div>
    <nav>
        <button class="button" type="button" data-action="restart">Generuj kolejne pismo</button>
    </nav>
  </section>
</div>



<script>
    // Global variables
    let topicsData = [];
    let formTypesData = {};
    let targetsData = {};
    let currentStep = 0;
    const totalSteps = 4;

    function showStep(stepNumber) {
        document.querySelectorAll('#generator>section').forEach(section => {
            section.classList.remove('active');
        });

        const currentSection = document.getElementById(`step-${stepNumber}`);
        if (currentSection) {
            currentSection.classList.add('active');
        }

        document.getElementById('step-indicator').textContent = `Krok ${stepNumber + 1} z ${totalSteps}`;

        currentStep = stepNumber;
    }

    function nextStep() {
        if (currentStep < totalSteps - 1) {
            // Validate current step before proceeding
            if (validateCurrentStep()) {
                showStep(currentStep + 1);
            }
        }
    }

    function validateCurrentStep() {
        switch(currentStep) {
            case 0:
                return true; // No validation needed for intro step
            case 1:
                return validateTopics();
            case 2:
                return validateForm();
            default:
                return true;
        }
    }

    function validateForm() {
        const formType = document.getElementById('formType').value;
        const target = document.getElementById('target').value;

        if (!formType) {
            alert('Proszę wybrać typ pisma');
            return false;
        }

        if (!target) {
            alert('Proszę wybrać adresata');
            return false;
        }

        return true;
    }
    
    function restartWizard() {
        // Reset form
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        document.getElementById('formType').value = '';
        document.getElementById('target').value = '';
        document.getElementById('output').textContent = '';
        document.getElementById('status').textContent = 'Gotowy do generowania';

        // Go back to step 1 (skip intro)
        showStep(1);
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            // Load topics
            const topicsResponse = await fetch('/generator/topics');
            topicsData = await topicsResponse.json();
            renderTopics();

            // Load form types
            const formTypesResponse = await fetch('/generator/form_types');
            formTypesData = await formTypesResponse.json();
            renderFormTypes();

            // Load targets
            const targetsResponse = await fetch('/generator/targets');
            targetsData = await targetsResponse.json();

            // Add event listeners for navigation buttons
            document.addEventListener('click', (e) => {
                if (e.target.dataset.action === 'next') {
                    nextStep();
                } else if (e.target.dataset.action === 'restart') {
                    restartWizard();
                }
            });
        } catch (error) {
            console.error('Error initializing data:', error);
            alert('Wystąpił błąd podczas ładowania danych. Odśwież stronę i spróbuj ponownie.');
        }
    });
    
    // Render topics checkboxes
    function renderTopics() {
        const container = document.getElementById('fs-topics');

        container.innerHTML = Object.entries(topicsData).map(([id, topic]) => `
            <label>
              <input type="checkbox" name='topics[]' value="${id}" onchange="validateTopics()">
              ${topic.title}
            </label>
        `).join('');
    }
    
    // Render form types dropdown
    function renderFormTypes() {
        const select = document.getElementById('formType');
        select.innerHTML = '<option value="">Wybierz typ pisma</option>';
        
        Object.entries(formTypesData).forEach(([id, data]) => {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = data || id;
            select.appendChild(option);
        });
        
        select.disabled = false;
        select.addEventListener('change', renderTargets);
    }
    
    // Render targets based on selected form type
    function renderTargets() {
        const formType = document.getElementById('formType').value;
        const targetSelect = document.getElementById('target');
        
        targetSelect.innerHTML = '<option value="">Wybierz adresata</option>';
        targetSelect.disabled = true;
        
        if (!formType) return;
        
        // Filter targets that support the selected form type
        const availableTargets = Object.entries(targetsData)
            .filter(([_, target]) => target.forms.includes(formType))
            .sort((a, b) => a[1].title.localeCompare(b[1].title));
        
        availableTargets.forEach(([id, target]) => {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = id; //target.title;
            targetSelect.appendChild(option);
        });
        
        targetSelect.disabled = false;
    }
    
    // Validate that 1-3 topics are selected
    function validateTopics() {
        const selectedTopics = document.querySelectorAll('fieldset#fs-topics input[type="checkbox"]:checked');
        const errorElement = document.getElementById('topicError');
        
        if (selectedTopics.length === 0 || selectedTopics.length > 3) {
            errorElement.style.display = 'block';
            return false;
        }
        
        errorElement.style.display = 'none';
        return true;
    }
    
    // Get selected topic IDs
    function getSelectedTopicIds() {
        return Array.from(document.querySelectorAll('#fs-topics input[type="checkbox"]:checked'))
            .map(checkbox => checkbox.value);
    }
    
    // Generate button click handler
    document.getElementById('generateButton').addEventListener('click', async () => {
        const button = document.getElementById('generateButton');
        const output = document.getElementById('output');
        const status = document.getElementById('status');
        
        // Validate form
        if (!validateForm()) {
            return;
        }
        
        const topicIds = getSelectedTopicIds();
        const formType = document.getElementById('formType').value;
        const target = document.getElementById('target').value;
                    
        // Clear previous output and move to results step
        output.textContent = '';
        showStep(3);
        
        try {
            // Build URL with query parameters
            const params = new URLSearchParams();
            params.append('topics', JSON.stringify(topicIds));
            params.append('form_type', formType);
            params.append('target', target);
            
            button.classList.add('disabled')
            
            // Add time fillers for the countdown
            const timeFillers = [
                'Rozpoczynam generowanie...',
                'Czytam Miejską Agendę Parkingową...',
                'Czytam Przepisy o Ruchu Drogowym...',
                'Szukam absurdalnych przykładów dla urozmaicenia pisma...',
                'Sprawdzam co w temacie ma do powiedzenia NIK...',
                'Czytam decyzję NSA z 2018 roku...',
                'Patrzę na możliwe rozwiązania...'
            ].sort(() => Math.random() - 0.5);
            
            let countdown = 40;
            let countdownInterval;
            
            // Start countdown
            const startCountdown = () => {
                countdownInterval = setInterval(() => {
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        return;
                    }
                    countdown--;
                    const filler = timeFillers[Math.floor(timeFillers.length * (countdown / 40))];
                    status.textContent = `${filler} (${countdown}s)`;
                }, 1000);
            };
            
            // Start the countdown
            startCountdown();
            
            const response = await fetch(`/generator/stream?${params.toString()}`, {
                method: 'GET',
                headers: {
                    'Accept': 'text/event-stream'
                }
            });
            
            // Check if response is OK
            if (!response.ok) {
                const error = await response.text();
                throw new Error(error);
            }
            
            // Clear the countdown when we start reading
            if (countdownInterval) clearInterval(countdownInterval);
            
            // Process the stream as text
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            
            while (true) {
                const { done, value } = await reader.read();
                
                if (done) {
                    status.textContent = 'Zakończono generowanie';
                    break;
                }
                
                // Decode the chunk
                const chunk = decoder.decode(value, { stream: true });
                buffer += chunk;
                
                // Process complete events (they end with double newline)
                const events = buffer.split('\n\n');
                buffer = events.pop() || ''; // Keep incomplete event in buffer
                
                for (const event of events) {
                    if (!event.startsWith('data: ')) continue;
                    
                    const eventData = event.slice(6).trim();
                    
                    // Check for done signal
                    if (eventData === '[DONE]') {
                        status.textContent = 'Zakończono generowanie';
                        continue;
                    }
                    
                    try {
                        const data = JSON.parse(eventData);
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }

                        if (data.content) {
                            output.textContent += data.content;
                            // Auto-scroll to bottom
                            output.scrollTop = output.scrollHeight;
                        }
                    } catch (e) {
                        console.error('Error parsing event:', e);
                    }
                }
            }
            
        } catch (error) {
            console.error('Error:', error);
            const parsed = JSON.parse(error.message);
            if (parsed.error) {
                status.textContent = `Błąd: ${parsed.error}`;
            } else {
                status.textContent = `Błąd: ${error.message}`;
            }
        } finally {
            button.classList.remove('disabled')
        }
    });
</script>


{% endblock %}
